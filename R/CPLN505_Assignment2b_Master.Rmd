---
title: "CPLN505 Assignment II - Assessing Water Infrastructure Need"
author: "Oliver Atwood & Charlie Townsley"
date: "2023-03-01"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: flatly
    highlight: kate
    code_folding: hide
    code_download: true
---

# Part I: Comparing Groups and Testing for Association and Correlation
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
rm(list=ls())
```

```{r packages data and colors, warning = FALSE, message = FALSE}
#install packages
#only run once
#install.packages("tidyverse")
#install.packages("dplyr")
#install.packages("gt")
#install.packages("ggplot2")
#install.packages("reshape2")
#install.packages("scales")
#install.packages("gmodels")
#install.packages("DT")
#install.packages("corrplot")
#install.packages("Hmisc")
#install.packages("car")
#install.packages("BAMMtools")
#install.packages("broom")
#install.packages("stargazer")

#run every session
library(tidyverse)
library(dplyr)
library(gt)
library(ggplot2)
library(reshape2)
library(scales)
library(gmodels)
library(DT)
library(corrplot)
library(Hmisc)
library(car)
library(gridExtra)
library(BAMMtools)
library(broom)
library(stargazer)

#set colors
palette <- c("#a02300", "#0059c7", "#6496b4", "#E1B93C")
#red and gold are accent
#blue is chart
#dark blue is outline

cwns2012 <- read_csv("https://raw.githubusercontent.com/c-townsley/pbn_a2b_repo/main/Data/cwns2012.csv?token=GHSAT0AAAAAACAEJN5DRTWOHJRNE36CS67GZAZCUFQ")
```


## Memo

**To:** Mayor Kenney  
**From:** Oliver Atwood and Charlie Townsley, O+C Analytics  
**Subject:** The Water Crisis in Philadelphia  

Hey Mayor Kenney, we know you're a busy man, but we've got something important to say! We've got a real problem on our hands, and it's not just about the potholes in the streets or the trash in the alleys. It's about the water.

Using the magic of computers, our team conducted a statistical analysis of national wastewater treatment facility data, and we found that Philadelphia is in desperate need of some serious investment in our water treatment infrastructure. We're talking about \$1.29 billion, Mayor, over $400 million more than the national average! That's a lot of cash.

Now, I know what you're thinking. "Why should I care about this?" Well, let me tell you, Mayor. Without clean water, we've got nothing. No coffee, no beer, no nothing! And that's just the beginning. A lack of investment in water infrastructure can lead to serious health risks, economic losses, and environmental degradation. We’re talking *sewage in the rivers*, Mayor!

We've found that the level of investment needed is correlated with many other values nationally, including population density, low median income, and high projected changes in population density and number of residential households receiving treatment.  Another correlation we unearthed was one of investment need with use of a combined sewer system. Remember that sewage in the rivers I mentioned earlier? Well, if you’re using a combined sewer and it rains, even a little bit, bam! Sewage in the rivers.

Now our analysis has truly been world class, but we need to dig deeper, Mayor. We need to figure out exactly what's going on in our city and come up with a plan to fix it. That's why we're requesting an additional round of research funding to look into this matter further. Specifically, we would like to further explore the relationships between need combined sewer systems, and systems that contribute to highly polluted water bodies. We need to understand the unique challenges we're facing and come up with a solution before it's too late.

So, Mayor Kenney, we’re counting on you to take this seriously. We need to invest in our water infrastructure if we want to have a healthy, thriving city. Let's get to work.

Sincerely,

Oliver Atwood and Charlie Townsley
O+C Analytics

*Update your conclusion to the report to Mayor Kenney summarizing your findings. What additional variables would be helpful to include? What are the major implications of your findings?*

*Highlight conclusion updates*


# Part I.I: Create Metrics to Contextualize Reported Need

We generated the below metrics to measure potential drivers of reported need.
```{r add resilience metrics}
cwns2012 <- cwns2012 %>% 
  mutate(proj_change_res_rec_collctn = PROJ_RES_REC_COLLCTN - PRES_RES_REC_COLLCTN) %>% 
  mutate(proj_prcntchng_res_rec_collctn = (proj_change_res_rec_collctn / PRES_RES_REC_COLLCTN)*100) %>% 
  mutate(proj_change_res_rec_trmt = PROJ_RES_REC_TRMT - PRES_RES_REC_TRMT) %>% 
  mutate(proj_prcntchng_res_rec_trmt = (proj_change_res_rec_trmt / PRES_RES_REC_TRMT)*100) %>% 
  mutate(proj_chng_n_res_rec_collctn = PROJ_N_RES_REC_COLLCTN - PRES_N_RES_REC_COLLCTN) %>% 
  mutate(proj_prcntchng_n_res_rec_collctn = (proj_chng_n_res_rec_collctn / PRES_N_RES_REC_COLLCTN)*100) %>% 
  mutate(proj_chng_n_res_rec_trmt = PROJ_N_RES_REC_TRMT - PRES_N_RES_REC_TRTM) %>% 
  mutate(proj_prcntchng_n_res_rec_trmt = (proj_chng_n_res_rec_trmt / PRES_N_RES_REC_TRTM)*100) %>% 
  mutate(res_pop10_dens = (POP10/(ALAND + AWATER))*1e+6) %>% 
  mutate(res_pop00_dens = (POP00/(ALAND + AWATER))*1e+6) %>%
  mutate(res_pop90_dens = (POP90/(ALAND + AWATER))*1e+6) %>%
  mutate(res_pop80_dens = (POP80/(ALAND + AWATER))*1e+6) %>% 
  mutate(res_pop_dens_chng_80_10 = (res_pop10_dens - res_pop80_dens)) %>% 
  mutate(res_pop_dens_prcnt_chng_80_10 = (res_pop_dens_chng_80_10 / res_pop80_dens)*100) %>%
  mutate(medinc_prcnt_chng_69_09 = ((MEDINC09 - MEDINC69)/MEDINC69)*100)
  
#r clear Nans and Inf values
cwns2012[sapply(cwns2012, is.nan)] <- 0
cwns2012[sapply(cwns2012, is.infinite)] <- 0

#Interactive Summary Table of Resilience Measures by EPA Region
cwns2012 %>% 
  dplyr::select(TOTAL_OFFICIAL_NEED, EPA_REGION, proj_change_res_rec_collctn, proj_prcntchng_res_rec_collctn, 
         proj_change_res_rec_trmt, proj_prcntchng_res_rec_trmt, proj_chng_n_res_rec_collctn, 
         proj_prcntchng_n_res_rec_collctn, proj_chng_n_res_rec_trmt, proj_prcntchng_n_res_rec_trmt,
         res_pop10_dens, res_pop10_dens, res_pop00_dens, res_pop90_dens, res_pop80_dens, 
         res_pop_dens_chng_80_10, medinc_prcnt_chng_69_09) %>% 
  DT::datatable(., options = list(scrollX = TRUE))
```
  

# Part I.II: Summary Statistics of the Data

## Resilience Metrics


**Projected Change in Residential Population Receiving Collection** 
```{r residential population receiving collection}
summary(cwns2012$proj_change_res_rec_collctn)
```


**Projected Percent Change in Residential Population Receiving Collection**
```{r % residential population receiving collection}
summary(cwns2012$proj_prcntchng_res_rec_collctn)
```


**Projected Change in Residential Population Receiving Treatment**
```{r residential population receiving treatment}
summary(cwns2012$proj_change_res_rec_trmt)
```


**Projected Percent Change in Residential Population Receiving Treatment**
```{r % change in residential population receiving treatment}
summary(cwns2012$proj_prcntchng_res_rec_trmt)
```


**Projected Change in Non-Residential Population Receiving Collection**
```{r non-residential population receiving collection}
summary(cwns2012$proj_chng_n_res_rec_collctn)
```


**Projected Percent Change in Non-Residential Population Receiving Collection**
```{r % non-residential population receiving collection}
summary(cwns2012$proj_prcntchng_n_res_rec_collctn)
```


**Projected Change in Non-Residential Population Receiving Treatment**
```{r non-residential population receiving treatment}
summary(cwns2012$proj_chng_n_res_rec_trmt)
```


**Projected Percent Change in Non-Residential Population Receiving Treatment**
```{r % non-residential population receiving treatment}
summary(cwns2012$proj_prcntchng_n_res_rec_trmt)
```


**Residential Population Density 2010** 
*units are persons per kilometer^2^*
```{r Residential population density 2010}
summary(cwns2012$res_pop10_dens)
```


**Change in Population Density 1980 - 2010**
```{r change in res pop density 1980 - 2010}
summary(cwns2012$res_pop_dens_chng_80_10)
```


**Percent Change in Population Density 1980 - 2010**
```{r percent change in res pop density 1980 - 2010}
summary(cwns2012$res_pop_dens_prcnt_chng_80_10)
```


**Percent Change in Median Income 1969 - 2009**
```{r median income 1969 - 2009}
summary(cwns2012$medinc_prcnt_chng_69_09)
```

## Summary Tables

Tables and figures that describe the trends we see in the data, beginning with the top and bottom 10 facilities with the greatest and least need for water infrastructure.
```{r top ten by need}

#Create a new dataframe with the top ten facilities by need
need_top10 <- cwns2012 %>% 
  arrange(desc(TOTAL_OFFICIAL_NEED)) %>% 
  filter(TOTAL_OFFICIAL_NEED != 0) %>% 
  slice(1:10)

#Create a table with the top ten facilities by need and geography
need_top10 %>% 
  dplyr::select(TOTAL_OFFICIAL_NEED, FACILITY_CITY, COUNTYNAME, STATE, EPA_REGION) %>% 
  gt() %>% 
  tab_header(title = "Top Ten Facilities by Need") %>% 
  fmt_currency(columns = c(TOTAL_OFFICIAL_NEED), currency = "USD")

```



```{r bottom ten by need}

#Create a new dataframe with the bottom ten facilities by need
need_bot10 <- cwns2012 %>% 
  arrange(TOTAL_OFFICIAL_NEED) %>% 
  filter(TOTAL_OFFICIAL_NEED != 0) %>% 
  slice(1:10)

#Create a table with the bottom ten facilities by need and geography
need_bot10 %>% 
  dplyr::select(TOTAL_OFFICIAL_NEED, FACILITY_CITY, COUNTYNAME, STATE, EPA_REGION) %>% 
  gt() %>% 
  tab_header(title = "Bottom Ten Facilities by Need") %>% 
  fmt_currency(columns = c(TOTAL_OFFICIAL_NEED), currency = "USD")

```


**Mean Total Official Need**
```{r mean total need}
total_need_mean <- mean(cwns2012$TOTAL_OFFICIAL_NEED)
total_need_mean
```


**Mean Official Need in Philadelphia**
```{r Philadelphia mean official need}
philly_facilities <- cwns2012 %>% 
  filter(STATE == "PA", FACILITY_CITY == "PHILADELPHIA")

need_philly_mean <- mean(philly_facilities$TOTAL_OFFICIAL_NEED)

need_philly_mean
```


**Total Official Need in Philadelphia**
```{r Philadelphia total official need}
need_philly_total <- sum(philly_facilities$TOTAL_OFFICIAL_NEED)

need_philly_total
```


**Difference between Mean Official Need in Philadelphia and National Mean Total Official Need**  
Mean budgeted need of Philadelphia facilities is $407,713,550 higher than mean total official need.
```{r mean philly need less mean national need}
need_philly_mean - total_need_mean
```


**Calculate additional means of density and median income**  
```{r calculate mean density and median income for philadelphia}
density_philly_mean <- mean(philly_facilities$res_pop10_dens)
medincome_philly_mean <- mean(philly_facilities$MEDINC09)
print('Mean Philadelphia Density')
density_philly_mean
print('Mean Philadelphia Median Income')
medincome_philly_mean
```




**Test distribution of log-adjusted Total Official Need**  
*Mean of all facilities in gold*  
*Mean of Philly facilities in red*
```{r Need Histogram}
cwns2012 <- cwns2012 %>% 
  mutate(log_TOTAL_NEED = ifelse(TOTAL_OFFICIAL_NEED > 0, log(TOTAL_OFFICIAL_NEED), TOTAL_OFFICIAL_NEED))

ggplot(cwns2012, aes(x=log_TOTAL_NEED)) +
  geom_histogram(color="#0059c7", size=.1, fill="#6496b4", binwidth=.5, alpha=0.8) +
  geom_vline(aes(xintercept=mean(log_TOTAL_NEED)), color="#E1B93C") +
  geom_vline(aes(xintercept=mean(log(philly_facilities$TOTAL_OFFICIAL_NEED))), color="#a02300") +
  theme_bw()

```


**Test distribution of Median Income**  
*Mean of all facilities in gold*  
*Mean of Philly facilities in red*
```{r Income Density Curve}
cwns2012%>%
  ggplot(aes(x=MEANINC09)) +
  ggtitle("Median Income Distribution") +
  xlab("Distribution of Median Income (2009)") + ylab("Median Income") +
  geom_density(fill="#6496b4", size=.35, color="#0059c7", alpha=0.8) +
  geom_vline(aes(xintercept=mean(MEANINC09)), color="#E1B93C") +
  geom_vline(aes(xintercept=mean(philly_facilities$MEANINC09)), color="#a02300") +
  theme_bw()

```


## EPA Regions by Resilience Measures

```{r plot of need vs mean density by epa region}
#Summarize total need and group by EPA region
mean_density_need_epa <- cwns2012 %>%
  group_by(EPA_REGION) %>% 
  summarise(count = n(), mean_popdens = mean(res_pop10_dens), mean_need = mean(TOTAL_OFFICIAL_NEED))

ggplot(mean_density_need_epa, aes(x = mean_popdens, y = mean_need)) +
  geom_smooth(method=lm, color="#0059c7") +
  geom_point(size=3, color="black", fill="#6496b4", shape=21, alpha=.5) +
  ggtitle("Population Density vs. Total Need, by EPA Region") +
  geom_text(aes(label = rownames(mean_density_need_epa), hjust = 1.75, vjust = 1)) +
  xlab("Mean Population Density (2010)") + ylab("Mean Official Need") +
  theme_bw()
  
```

Density and need seem to be correlated. So how does the mean need of Philadelphia facilities compare with the mean values for each EPA region?

Here is the same plot with Philadelphia shown as a red dot.
```{r plot of need vs mean density by epa region plus philadelphia point, message=FALSE}
mean_density_need_epa <- cwns2012 %>%
  group_by(EPA_REGION) %>% 
  summarise(count = n(), mean_popdens = mean(res_pop10_dens), mean_need = mean(TOTAL_OFFICIAL_NEED))

ggplot(mean_density_need_epa, aes(x = mean_popdens, y = mean_need)) +
  geom_smooth(method=lm, color="#0059c7") + 
  geom_point(size=3, color="black", fill="#6496b4", shape=21, alpha=.5) +
  ggtitle("Population Density vs. Total Need, by EPA Region") +
  geom_text(aes(label = rownames(mean_density_need_epa), hjust = 1.75, vjust = 1)) +
  xlab("Mean Population Density (2010)") + ylab("Mean Official Need") +
  geom_point(aes(x = density_philly_mean , y = need_philly_mean),size=3, shape=21,color="black", fill="#a02300") +
  theme_bw()

```


How does Philly's density and need compare to other cities in the same EPA region?
```{r plot of need vs mean density in epa region 3}
#Summarize total need in EPA region 3
mean_density_need_R3 <- cwns2012 %>%
  filter(EPA_REGION == '3') %>% 
  group_by(FACILITY_CITY) %>% 
  summarise(count = n(), mean_popdens = mean(res_pop10_dens), mean_need = mean(TOTAL_OFFICIAL_NEED))

ggplot(mean_density_need_R3, aes(x = mean_popdens, y = mean_need)) +
  geom_point(size=3, color="black", fill="#6496b4", shape=21, alpha=.5) +
  ggtitle("Population Density vs. Total Need by City in EPA Region 3") +
  xlab("Mean Population Density (2010)") + ylab("Mean Official Need") +
  geom_point(aes(x = density_philly_mean , y = need_philly_mean),size=3, shape=21,color="black", fill="#a02300") +
  theme_bw()

```


What about income and need in the same EPA region?
```{r plot of need vs median income in epa region 3}
#Summarize total need in EPA region 3
mean_income_need_R3 <- cwns2012 %>%
  filter(EPA_REGION == '3') %>% 
  group_by(FACILITY_CITY) %>% 
  summarise(count = n(), mean_medinc = mean(MEDINC09), mean_need = mean(TOTAL_OFFICIAL_NEED))

ggplot(mean_income_need_R3, aes(x = mean_medinc, y = mean_need)) +
  geom_point(size=3, color="black", fill="#6496b4", shape=21, alpha=.5) +
  ggtitle("Median Income vs. Total Need by City in EPA Region 3") +
  xlab("Median Income (2009)") + ylab("Mean Official Need") +
  geom_point(aes(x = medincome_philly_mean , y = need_philly_mean),size=3, shape=21,color="black", fill="#a02300") +
  theme_bw()

```




# Part I.III: Tests of Association

## Comparing Budgeted Need for Facilities with CSS vs MS4s


Summary of overall budgeted need for facilities with CSS (Combined Sewer Systems):
```{r css need}
cwns2012_css <- filter(cwns2012, CSS == 1)
summary(cwns2012_css$TOTAL_OFFICIAL_NEED)
```


Summary of overall budgeted need for facilities with MS4s (Municipal Separate Storm Sewer Systems):
```{r ms4 need}
cwns2012_ms4 <- filter(cwns2012, MS4 == 1)
summary(cwns2012_ms4$TOTAL_OFFICIAL_NEED)
```




We can see that mean budgeted need for facilities with CSS is higher than for facilities with MS4s, but is this difference statistically meaningful?

Conducting a Welch two-sample t-test reveals that these means are significantly different from each other.

It gives a t-statistic that is greater than the critical value for significance of 1.96 and allows us reject the null hypothesis that the mean budgeted need is the same for CSS and MS4s with greater than 95% confidence.
```{r two-sample t-test css vs ms4}
t.test(TOTAL_OFFICIAL_NEED ~ CSS, data = cwns2012, paired = FALSE)
```




## Comparing Need by Association with a Total Maximum Daily Load (TMDL) of one or more pollutants


Budgeted need for facilities that contribute to a TMDL receiving water body:
```{r yes tmdl}
cwns_yestmdl <- filter(cwns2012, TMDL_INDICATOR == "Y")
summary(cwns_yestmdl$TOTAL_OFFICIAL_NEED)
```


Budgeted need for facilities that do not contribute to a TMDL receiving water body:
```{r no tmdl}
cwns_notmdl <- filter(cwns2012, TMDL_INDICATOR == "N")
summary(cwns_notmdl$TOTAL_OFFICIAL_NEED)
```


Mean budgeted need for facilities that do contribute to a TMDL is higher than for facilities that do not.

Running a Welch two sample t-test shows that mean budgeted need is statistically different between facilities that do and do not contribute to a TMDL.

It gives a t-statistic that surpasses the critical value for significance of 1.96 and allows us reject the null hypothesis that the means are the same with greater than 95% confidence.
```{r two-sample t-test tmdl}
t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = cwns2012, paired = FALSE)
```




## Comparing Significance of Difference between Facilities with and without TMDL by EPA Region

We found a statistically significant difference in mean budgeted need between facilities that do contribute to a TMDL and those that do not in just four out of ten EPA Regions. These were regions 2, 3, 5, and 6.

Because we could not reject the null hypothesis (that means are different) in 60% of EPA regions, we do not see TMDL by EPA region as a useful metric for further exploration.


**Region 2**
```{r two-sample t-test tmdl for epa region 2}
t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = filter(cwns2012, EPA_REGION == 2), paired = FALSE)
```


**Region 3**
```{r two-sample t-test tmdl for epa region 3}
t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = filter(cwns2012, EPA_REGION == 3), paired = FALSE)
```


**Region 5**
```{r two-sample t-test tmdl for epa region 5}
t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = filter(cwns2012, EPA_REGION == 5), paired = FALSE)
```


**Region 6**
```{r two-sample t-test tmdl for epa region 6}
t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = filter(cwns2012, EPA_REGION == 6), paired = FALSE)
```

We found no statistically significant difference (failed to reject the null hypothesis) in mean budgeted need between facilities that do contribute to a TMDL and those that do not in regions 1, 4, 9, and 10.


**Region 1**
```{r two-sample t-test tmdl for epa region 1}
t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = filter(cwns2012, EPA_REGION == 1), paired = FALSE)
```


**Region 4**
```{r two-sample t-test tmdl for epa region 4}
t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = filter(cwns2012, EPA_REGION == 4), paired = FALSE)
```


**Region 9**
```{r two-sample t-test tmdl for epa region 9}
t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = filter(cwns2012, EPA_REGION == 9), paired = FALSE)
```


**Region 10**
```{r two-sample t-test tmdl for epa region 10}
t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = filter(cwns2012, EPA_REGION == 10), paired = FALSE)
```


**Regions 7 and 8**  
Regions 7 and 8 both failed the t-test outright because there was not enough data.
```{r two-sample t-test tmdl for epa region 7 and 8, error=TRUE}
# t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = filter(cwns2012, EPA_REGION == 7), paired = FALSE)

# t.test(TOTAL_OFFICIAL_NEED ~ TMDL_INDICATOR, data = filter(cwns2012, EPA_REGION == 8), paired = FALSE)
```




## Chi-square Test of Regional Differences in Total Official Need

To test for association between total budgeted need and EPA region, we first need to divide total need into a limited number of categories that a cross table can process.
```{r breaking total offical need into 6 classes}
#First create a new column that breaks total official need into six classes
cwns_int <- cwns2012 %>%
  mutate(need_int = ntile(cwns2012$TOTAL_OFFICIAL_NEED, 5)) %>% 
  dplyr::select(need_int, TOTAL_OFFICIAL_NEED)
```

Chi-Square test of association between need and EPA region shows that we can confidently reject the null hypothesis that need and epa region are independent variables due to the incredibly small p-value.
```{r cross table of total official need by epa region}
CrossTable(cwns2012$EPA_REGION, cwns_int$need_int,  fisher = FALSE, chisq = TRUE, 
             expected = TRUE, sresid = FALSE, format="SPSS")
```




## Testing 5 Variables for Association

Below are five variables from those we originally explored, divided into five equal intervals and tested for their association with total reported need.


### 2010 residential population density
We can confidently reject the null hypothesis that need and 2010 residential population density are independent variables due to the teeny tiny p-value (p = 5.427126e-207).

```{r cross table of association between total official need and variable 1}
#First create a new column that breaks res_pop10_dens into distinct classes
#1 is low and 5 is high
cwns_int <- cwns_int %>%
  mutate(res_pop10_dens = ntile(cwns2012$res_pop10_dens, 5))

#cross tab of res_pop10_dens and need
CrossTable(cwns_int$need_int, cwns_int$res_pop10_dens,  fisher = FALSE, chisq = TRUE, 
             expected = TRUE, sresid = FALSE, format="SPSS")
```


### Residential population density change from 1980 - 2010
We can confidently say that need and Residential population density change from 1980 - 2010 are associated due to the smol p-value (p = 8.912258e-179).

```{r cross table of association between total official need and res pop dens chng 1980 - 2010}
#First create a new column that breaks res_pop10_dens into six classes
cwns_int <- cwns_int %>%
  mutate(res_pop_dens_chng_80_10 = ntile(cwns2012$res_pop_dens_chng_80_10, 5))

#cross tab of res_pop10_dens and need
CrossTable(cwns_int$need_int, cwns_int$res_pop_dens_chng_80_10,  fisher = FALSE, chisq = TRUE, 
             expected = TRUE, sresid = FALSE, format="SPSS")
```


### 2010 population size

We can confidently say that need and 2010 population size are associated due to the very small p-value (p =  5.214784e-217).
```{r cross table of association between need and pop10}
#First create a new column that breaks res_pop10 into six classes
cwns_int <- cwns_int %>%
  mutate(POP10 = ntile(cwns2012$POP10, 5))

#cross tab of res_pop10_dens and need
CrossTable(cwns_int$need_int, cwns_int$POP10,  fisher = FALSE, chisq = TRUE, 
             expected = TRUE, sresid = FALSE, format="SPSS")
```


## Projected change in residential receiving treatment

Interestingly, the p-value for need and Projected change in residential receiving treatment is exactly 0. This could mean they are very closely associated and warrants further testing.

```{r cross table of association between need and proj_change_res_rec_trmt}
#First create a new column that breaks res_pop10_dens into six classes
cwns_int <- cwns_int %>%
  mutate(proj_change_res_rec_trmt = ntile(cwns2012$proj_change_res_rec_trmt, 5))

#cross tab of res_pop10_dens and need
CrossTable(cwns_int$need_int, cwns_int$proj_change_res_rec_trmt,  fisher = FALSE, chisq = TRUE, 
             expected = TRUE, sresid = FALSE, format="SPSS")
```


### Projected change in residential receiving collection

The crosstable between need and projected change in residential receiving collection is also exactly 0, which suggests projected change in residential receiving collection and treatment are closely related to eachother.

```{r cross table of association between need and proj_change_res_rec_collctn}
#First create a new column that breaks the variable into six classes
cwns_int <- cwns_int %>%
  mutate(proj_change_res_rec_collctn = ntile(cwns2012$proj_change_res_rec_collctn, 5))

#cross tab of var5 and need
CrossTable(cwns_int$need_int, cwns_int$proj_change_res_rec_collctn,  fisher = FALSE, chisq = TRUE, 
             expected = TRUE, sresid = FALSE, format="SPSS")
```




# Part I.IV: Correlation

Correlation tests were run for all the resilience measures, as well as for 2010 population, 2010 population density, 2009 median income, and present residential receiving treatment.
Values with insignificant correlation with total official need were commented out of the code.

### Correlation of Variables of Interest with Total Official Need

A number of variables exhibited no significant correlation with total official need at all. These were:

* medinc_prcnt_chng_69_09
* res_pop_dens_prcnt_chng_80_10
* proj_prcntchng_res_rec_trmt
* proj_prcntchng_res_rec_collctn
* proj_prcntchng_n_res_rec_trmt
* proj_prcntchng_n_res_rec_collctn

```{r insignificant Correlation Coefficient Tests}
#cor(cwns2012$medinc_prcnt_chng_69_09, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
#cor(cwns2012$res_pop_dens_prcnt_chng_80_10, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
#cor(cwns2012$proj_prcntchng_res_rec_trmt, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
#cor(cwns2012$proj_prcntchng_res_rec_collctn, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
#cor(cwns2012$proj_prcntchng_n_res_rec_trmt, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
#cor(cwns2012$proj_prcntchng_n_res_rec_collctn, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```


The following 12 variables exhibited measurable correlation with need (in ascending order):
* medinc09
* PCTWHITE10
* proj_chng_n_res_rec_trmt
* proj_chng_n_res_rec_collctn
* POP10
* CSS
* proj_change_res_rec_collctn
* proj_change_res_rec_trmt
* res_pop_dens_chng_80_10
* res_pop10_dens
* PRES_RES_REC_COLLCTN
* PRES_RES_REC_TRMT

```{r scatter plots medinc and prcntwhite, fig.width=7}

ggmedinc <- ggplot(cwns2012, aes(x=log(MEDINC09), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("Median Income by Official Need") +
  xlab("Log-Adjusted Median Income (2009)") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

ggwhite <- ggplot(cwns2012, aes(x=log(PCTWHITE10), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("% White by Official Need") +
  xlab("Log-Adjusted % White (2010)") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

grid.arrange(ggmedinc, ggwhite, ncol = 2)
```

Median income seems to have an extremely weak correlation with need based on its correlation coefficient (0.052) and clustered correlation pattern.
```{r correlation medinc09}
cor(cwns2012$MEDINC09, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```
Percent white has substantially higher (but negative) correlation with need than median income (corr = -0.150) although the correlation plot above shows that the data skews toward a larger percent white.
```{r correlation PCTWHITE10}
cor(cwns2012$PCTWHITE10, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```

```{r Scatter Plot of proj chng in n-res pop rec trtmnt by Need, fig.width=7}

ggnrrt <- ggplot(cwns2012, aes(x=log(proj_chng_n_res_rec_trmt), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("Projected Change in Non-Res. Pop Receiving\nTreatment by Official Need") +
  xlab("Log-Adjusted Projected Change in Non-Res Pop\nReceiving Treatment") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5)+
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

ggnrrc <- ggplot(cwns2012, aes(x=log(proj_chng_n_res_rec_collctn), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("Projected Change in Non-Res Pop Receiving\nCollection by Official Need") +
  xlab("Log-Adjusted Projected Change in Non-Res Pop\nReceiving Collection") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5)+
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

grid.arrange(ggnrrt, ggnrrc, ncol = 2)
```

Projected change in non-residential population receiving treatment has a slight correlation with need (corr = 0.162) but we see the data is still widely distributed.
```{r correlation proj chng res rec trtmt}
cor(cwns2012$proj_chng_n_res_rec_trmt, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```

Projected change in non-residential population receiving collection has nearly the same slight correlation (corr = 0.163).
```{r correlation proj chng n res rec collctn}
cor(cwns2012$proj_chng_n_res_rec_collctn, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```


```{r Scatter Plot of Residential pop 2010 by Need, fig.width=7}

ggres10 <- ggplot(cwns2012, aes(x=log(POP10), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("Residential Population (2010) by Official Need") +
  xlab("Log-Adjusted Residential Population (2010)") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5)+
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

ggcss <- ggplot(cwns2012, aes(x=CSS, y=log(TOTAL_OFFICIAL_NEED))) +
  ggtitle("CSS Presence by Official Need") +
  xlab("CSS Presence") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5)+
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

grid.arrange(ggres10, ggcss, ncol = 2)

```

2010 population is in the same category of slight correlation (corr = 0.175) and wide distribution of points.
```{r correlation pop10}
cor(cwns2012$POP10, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```

Presence of CSS has a more notable correlation with need, although it is still relatively small (corr = 0.204).
```{r correlation CSS}
cor(cwns2012$CSS, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```


```{r Scatter Plot proj chng in res pop rec trtmnt by Need, fig.width=7}

ggrrt <- ggplot(cwns2012, aes(x=log(proj_change_res_rec_trmt), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("Projected Change in Res Pop Receiving\nTreatment by Official Need") +
  xlab("Log-Adjusted Projected Change in Res Pop\nReceiving Treatment") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5)+
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

ggrrc <- ggplot(cwns2012, aes(x=log(proj_change_res_rec_collctn), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("Projected Change in Res Pop Receiving\nCollection by Official Need") +
  xlab("Log-Adjusted Projected Change in Res Pop\nReceiving Collection") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5)+
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

grid.arrange(ggrrt, ggrrc, ncol = 2)
```

Projected change in residential population receiving collection improves on CSS (corr = 0.217).
```{r correlation proj chng res rec collctn}
cor(cwns2012$proj_change_res_rec_collctn, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```

Projected change in residential population receiving treatment has a very similar notable but moderate correlation (corr = 0.226).
```{r correlation proj chng res rec trmt}
cor(cwns2012$proj_change_res_rec_trmt, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```



```{r Scatter Plot res pop dens Change 1980 - 2010 by Need, fig.width=7}

ggpdc <- ggplot(cwns2012, aes(x=log(res_pop_dens_chng_80_10), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("Residential Pop Density Change by Official Need") +
  xlab("Log-Adjusted Residential Pop Density Change (1980 - 2010)") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

ggpd <- ggplot(cwns2012, aes(x=log(res_pop10_dens), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("Residential Pop Density (2010) by Official Need") +
  xlab("Log-Adjusted Residential Pop Density in 2010") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5)+
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

grid.arrange(ggpdc, ggpd, ncol = 2)

```

Change in residential population density from 1980 to 2010 has a moderate correlation with need that is notably higher than the above variables (corr = 0.299). However the clustering of data makes it seem like both these variables are less reliable than the previous two.
```{r correlation res pop dens chng}
cor(cwns2012$res_pop_dens_chng_80_10, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```

Although residential population density in 2010 still exhibits a moderate correlation with need overall, it's correlation coefficient is significantly higher than the rest of the variables we tested (corr = 0.422).
```{r correlation res pop10 dens}
cor(cwns2012$res_pop10_dens, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```


```{r Scatter Plot of pres rec collctn and trtmnt, fig.width=7}

ggprrc <- ggplot(cwns2012, aes(x=log(PRES_RES_REC_COLLCTN), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("Present Res Pop Receiving\nCollection by Official Need") +
  xlab("Log-Adjusted Present Res Pop Receiving Collection") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5)+
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

ggprrt <- ggplot(cwns2012, aes(x=log(PRES_RES_REC_TRMT), y=log(TOTAL_OFFICIAL_NEED))) + 
  ggtitle("Present Res Pop Receiving\nTreatment by Official Need") +
  xlab("Log-Adjusted Present Res Pop Receiving Treatment") + ylab("Log-Adjusted Official Need") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5)+
  geom_smooth(method=lm, color="#0059c7") +
  theme_bw()

grid.arrange(ggprrc, ggprrt, ncol = 2)

```

Present residential receiving collection also a correlation with need that is comparitively very high (corr = 0.529). The plot bears this out as well, with relatively tight clustering.
```{r correlation PRES_RES_REC_COLLCTN}
cor(cwns2012$PRES_RES_REC_COLLCTN, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```

Present residential receiving treatment has the highest overall correlation with need (corr = 0.531).
```{r correlation PRES_RES_REC_TRMT}
cor(cwns2012$PRES_RES_REC_TRMT, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```

***




# Part II.B

The second phase of this project is to better understand the relationships between the variables we started in Part I and need by running bivariate and multivariate linear regression models.

<br>

## Data Preparation and Preliminary Tests

In order to model infrastructure need, we need variables that represent it. We will include the following variables in our models based on their association and correlation with need as well as their policy relevance:

* MEDINC09
* PCTWHITE10
* POP10
* CSS
* proj_change_res_rec_trmt
* proj_change_res_rec_collctn
* res_pop10_dens  
* res_pop_dens_chng_80_10 
* PRES_RES_REC_TRMT
* PRES_RES_REC_COLLCTN

<br>

### Create Variables to Represent Need

```{r Calculate Residential Burden}
cwns2012 <- cwns2012 %>% 
  mutate(ResBurden = TOTAL_OFFICIAL_NEED/max(PROJ_RES_REC_COLLCTN, PROJ_RES_REC_TRMT)) %>% 
  mutate(LogResBurden = ifelse(ResBurden > 0, log(ResBurden), 0)) %>% 
  mutate(LogPOP10 = ifelse(POP10 > 0, log(POP10), 0)) %>% 
  mutate(LogMEDINC09 = ifelse(MEDINC09 > 0, log(MEDINC09), 0))
```

To better understand Philadelphia's especially high infrastructure need, we created the following additional variables:

* ResBurden
* LogResBurden
* LogPOP10
* LogMEDINC09

<br>

**Residential Burden**

```{r res burden charts}

ggresb <- cwns2012 %>%
  ggplot(aes(x=factor(0), y=ResBurden)) +
  ggtitle("Residential Burden") +
  xlab("") +ylab("") +
  geom_boxplot(fill="#6496b4", size=.35, color="#0059c7", alpha=0.8) +
  theme_bw() +
  theme(axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank())

gglogresb <- cwns2012 %>%
  ggplot(aes(x=factor(0), y=LogResBurden)) +
  ggtitle("Log of Residential Burden") +
  xlab("") +ylab("") +
  geom_boxplot(fill="#6496b4", size=.35, color="#0059c7", alpha=0.8) +
  theme_bw() +
  theme(axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank())

grid.arrange(ggresb, gglogresb, ncol = 2)

```

We created a `ResBurden` variable to understand if Philadelphia's high need could be driven by an overstretched system designed to serve more people than it currently does. We calculated residential burden as the ratio of total need to residential population served. If this variable were to be significant, its coefficient would tell us the expected increase (or decrease) in total need based on the ratio of need to residential pop served.

The box plot of `ResBurden` shows some significant outliers, but the value for most facilities is near zero. We then created a log transformed `LogResBurden` variable to deal with its extreme skew and get a more normal distribution. This shows us a log transformed mean below zero, meaning that the average facility need in dollars is lower than the amount of residences it serves.

<br>

**LogPOP10**

```{r LogPOP10 charts}

ggplogpop <- cwns2012%>%
  ggplot(aes(x=factor(0), y=LogPOP10)) +
  ggtitle("Log of 2010 Population") +
  xlab("") +ylab("") +
  geom_boxplot(fill="#6496b4", size=.35, color="#0059c7", alpha=0.8) +
  theme_bw() +
  theme(axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank())

ggppop <- cwns2012%>%
  ggplot(aes(x=factor(0), y=POP10)) +
  ggtitle("2010 Population") +
  xlab("") +ylab("") +
  geom_boxplot(fill="#6496b4", size=.35, color="#0059c7", alpha=0.8) +
  theme_bw() +
  theme(axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank())

grid.arrange(ggppop, ggplogpop, ncol = 2)

```

Because Philadelphia is one of the ten largest cities in the U.S. by population, `POP10` is an important variable for our analysis. A large regression coefficient and high significance would indicate that increases in population have an important affect on the need of the facilities that serve them. Because our population data is also significantly skewed by large outliers, we log transformed it as well by creating a `LogPOP10` variable.

The box plot of `LogPOP10` also shows some significant outliers, but the mean is well above zero. In fact, the mean population per facility in this data set is 304,727 which is notably lower than the 508,668 persons served by each of Philadelphia's three facilities.

<br>

**LogMEDINC09**

```{r LogMEDINC09 charts}

ggloginc <- cwns2012%>%
  ggplot(aes(x=factor(0), y=LogMEDINC09)) +
  ggtitle("Log of 2009 Median Income") +
  xlab("") +ylab("") +
  geom_boxplot(fill="#6496b4", size=.35, color="#0059c7", alpha=0.8) +
  theme_bw() +
  theme(axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank())

gginc <- cwns2012%>%
  ggplot(aes(x=factor(0), y=MEDINC09)) +
  ggtitle("2009 Median Income") +
  xlab("") +ylab("") +
  geom_boxplot(fill="#6496b4", size=.35, color="#0059c7", alpha=0.8) +
  theme_bw() +
  theme(axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank())

grid.arrange(gginc, ggloginc, ncol = 2)

```

Philadelphia is also one of the poorest large cities in the U.S. Therefore, income is an important variable to compare with need. A large and negative regression coefficient and high significance would indicate that increases in income have an important affect on need. Because our income data skews toward the top end of the distribution, we create a log transformed `LogMEDINC09` variable to have a more normal distribution to include in our regression models.

<br>

### Creating Binary "Dummy" Variables

```{r Dummy variable creation, message=FALSE, echo=FALSE}
getJenksBreaks(cwns2012$MEDINC09, 4)
getJenksBreaks(cwns2012$POP10, 5)

cwns2012 <- cwns2012 %>% 
  mutate(GrowingCity = ifelse(POP10-POP80 > 0, 1, 0)) %>% 
  mutate(lowincome = ifelse(MEDINC09 <= 54728, 1, 0)) %>% 
  mutate(lrgcity = ifelse(POP10 >=1000000, 1, 0)) #Cutoff of 1,000,000 to capture Philly

```

Suspecting that some factors influencing waste water infrastructure need in Philadelphia may be categorical rather than continuous, we created the three new binary dummy variables to include in our models. These are `GrowingCity`, `lowincome`, and `lrgcity`.

`GrowingCity` is meant to reflect the particular case of Philadelphia, which has experienced significant population growth since 1980.

Philadelphia is also a `lrgcity`, one of the 10 largest in the country, so we hypothesize being in this class of cities could also affect total need.

Finally, `lowincome` is also relevant to Philadelphia because it is a relatively low-income city, so we hypothesize this might relate to its high infrastructure need as well.

<br>

### One More Test: Multi-Colinearity

Finally, we've created a list of 18 variables we think would be good candidates to run our models on. Here's the list:

* res_pop10_dens  
* res_pop_dens_chng_80_10 
* proj_change_res_rec_trmt
* proj_change_res_rec_collctn
* POP10
* MEDINC09
* PRES_RES_REC_TRMT
* PRES_RES_REC_COLLCTN
* PCTWHITE10
* ResBurden  
* LogResBurden  
* LogOfficialNeed  
* LogPOP10
* LogMEDINC09
* CSS
* GrowingCity
* lowincome
* lrgcity

However, some of these variables might be too correlated with eachother or with total need to give us accurate predictions if they were to be in the same model. So, we ran pairwise correlations between variables (visualized with the correlogram below). This revealed that some of the variables we are interested in testing are highly correlated. 

First, we examined the correlation coefficients between our candidate variables and total official need:


```{r correlation matrix, fig.width=7, fig.height=5, fig.width=8}
#make matrix of variables we're testing
mod_vars <- cwns2012 %>% 
  dplyr::select(TOTAL_OFFICIAL_NEED, log_TOTAL_NEED, res_pop10_dens, res_pop_dens_chng_80_10,
                proj_change_res_rec_trmt, proj_change_res_rec_collctn, POP10, MEDINC09,
                ResBurden, LogResBurden, PRES_RES_REC_TRMT, PRES_RES_REC_COLLCTN, LogPOP10, LogMEDINC09,
                PCTWHITE10, CSS, GrowingCity, lowincome, lrgcity)

#compute correlation matrix
cormatrix <- cor(mod_vars) %>% 
  round(., 2)

#plot a correlogram
corrplot(cormatrix, method = "circle", type = "lower", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```

<br>

Specifically, the following variables exhibited high degrees of significance with each other:  

* `res_pop10_dens` & `res_pop_dens_chng_80_10`. We chose to use residential population density in 2010 moving forward because it has a higher correlation with total official need.
* `POP10` & `LogPOP10` & `lrgcity`
* `PRES_RES_REC_COLLCTN` & `PRES_RES_REC_TRMT` & `proj_change_res_rec_collctn` & `proj_change_res_rec_trmt`. We chose to move forward with projected change in residences receiving treatment because the corr. score is higher for treatment.
* `PRES_RES_REC_TRMT` & `ResBurden`
* `MEDINC09` & `LogMEDINC09` & `LogPOP10`
* `MEDINC09` & `LogMEDINC09` & `lowincome`
* Log of official need & log of residential burden, so we cannot use residential burden in our models.

We then looked at all the correlation scores between each of our candidate variables and official need to help us select further:

```{r correlations, echo=FALSE}
print('res_pop10_dens')
cor(cwns2012$res_pop10_dens, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('res_pop_dens_chng_80_10')
cor(cwns2012$res_pop_dens_chng_80_10, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('proj_change_res_rec_trmt')
cor(cwns2012$proj_change_res_rec_trmt, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('proj_change_res_rec_collctn')
cor(cwns2012$proj_change_res_rec_collctn, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('POP10')
cor(cwns2012$POP10, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('LogPOP10')
cor(cwns2012$LogPOP10, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('PRES_RES_REC_TRMT')
cor(cwns2012$PRES_RES_REC_TRMT, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('PCTWHITE10')
cor(cwns2012$PCTWHITE10, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('ResBurden')
cor(cwns2012$ResBurden, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('LogResBurden')
cor(cwns2012$LogResBurden, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('LogOfficialNeed')
cor(cwns2012$log_TOTAL_NEED, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('MEDINC09')
cor(cwns2012$MEDINC09, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('LogMEDINC09')
cor(cwns2012$LogMEDINC09, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('CSS')
cor(cwns2012$CSS, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('Growing City')
cor(cwns2012$GrowingCity, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
print('Low Income')
cor(cwns2012$lowincome, cwns2012$TOTAL_OFFICIAL_NEED, use="complete.obs", method="pearson")
```

We found that `ResBurden` has a correlation of 1 with Total Official Need, meaning Total Official Need is a function of `ResBurden`. Therefore, we exclude it from our regression analysis moving forward.

Based on correlation with Total Official Need, and elimination of one of a variable pair when colinearity is present, favoring the one with higher correlation with need, we narrowed down this list of variables to 7 independent variables.

Final variable list to test:  

* `PRES_RES_REC_TRMT` (cor with need = 0.53)
* `res_pop10_dens` (cor with need = 0.42)
* `CSS` (cor with need = 0.20)
* `LogPOP10` (cor with need = 0.18)
* `PCTWHITE10` (cor with need = -0.15)
* `LogMEDINC09` (cor with need = 0.05)
* `GrowingCity` (cor with need = .04)

<br>

## Bivariate Regressions

We then ran bivariate regressions to further clarify the relationships between `TOTAL_OFFICIAL_NEED` and each of the variables considered above.

Notably, plotting the residuals of these regressions shows a significant amount of heteroscedasticity in our variables. This suggests that these variables may bias our models toward less accurate predictions for high values of need.

```{r Scatter Plot 1}
bimod1 <- lm(TOTAL_OFFICIAL_NEED ~ PRES_RES_REC_TRMT, data = cwns2012)

bimod1_resid <- augment(bimod1)

ggplot(bimod1_resid, aes(x = .fitted, y = .resid)) + 
  ggtitle("Present Residential Receiving Treatment Regressed on Need") +
  xlab("Fitted") + ylab("Residuals") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#a02300") + 
  theme_bw()
```

```{r bivariate regression 1}
summary(bimod1)
```
**Need vs PRES_RES_REC_TRMT** appears to be significant and its coefficient suggests a 1 unit increase in residential pop receiving treatment leads to a $670 increase in need.


```{r Scatter Plot 2}
bimod2 <- lm(TOTAL_OFFICIAL_NEED ~ res_pop10_dens, data = cwns2012)

bimod2_resid <- augment(bimod2)

ggplot(bimod2_resid, aes(x = .fitted, y = .resid)) + 
  ggtitle("Residential Pop Density Regressed on Need") +
  xlab("Fitted") + ylab("Residuals") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#a02300") + 
  theme_bw()
```

```{r bivariate regression 2}
summary(bimod2)
```
**Need vs. res_pop10_dens** also appears to be significant and to result in a $106,509, per unit increase, in need.

```{r Scatter Plot 3}
bimod3 <- lm(TOTAL_OFFICIAL_NEED ~ CSS, data = cwns2012)

bimod3_resid <- augment(bimod3)

ggplot(bimod3_resid, aes(x = .fitted, y = .resid)) + 
  ggtitle("Combined Sewer System Regressed on Need") +
  xlab("Fitted") + ylab("Residuals") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#a02300") + 
  theme_bw()
```

```{r bivariate regression 3}
summary(bimod3)
```
The intercept indicates that when **CSS** is present and all other variables are constant, we can expect a $99,668,737 average increase in need than when there is no CSS (meaning there is MS4).


```{r Scatter Plot 4}
bimod4 <- lm(TOTAL_OFFICIAL_NEED ~ LogPOP10, data = cwns2012)

bimod4_resid <- augment(bimod4)

ggplot(bimod4_resid, aes(x = .fitted, y = .resid)) + 
  ggtitle("Log of Population 2010 Regressed on Need") +
  xlab("Fitted") + ylab("Residuals") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#a02300") + 
  theme_bw()
```

```{r bivariate regression 4}
summary(bimod4)
```
**Need vs. LogPOP10** also appears to be significant. For a 1 unit increase in this variable, we could expect a $15,565,206 increase (not log adjusted) in need.


```{r Scatter Plot 5}
bimod5 <- lm(TOTAL_OFFICIAL_NEED ~ PCTWHITE10, data = cwns2012)

bimod5_resid <- augment(bimod5)

ggplot(bimod5_resid, aes(x = .fitted, y = .resid)) + 
  ggtitle("Percent White 2010 Regressed on Need") +
  xlab("Fitted") + ylab("Residuals") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#a02300") + 
  theme_bw()
```

```{r bivariate regression 5}
summary(bimod5)
```
**PCTWHITE10 vs. Need** suggests that for each 1% increase in white population, we can expect a -$1,329,320 reduction in need (careful about causation vs. correlation!)


```{r Scatter Plot 6}
bimod6 <- lm(TOTAL_OFFICIAL_NEED ~ LogMEDINC09, data = cwns2012)

bimod6_resid <- augment(bimod6)

ggplot(bimod6_resid, aes(x = .fitted, y = .resid)) + 
  ggtitle("Median Income 2009 Regressed on Need") +
  xlab("Fitted") + ylab("Residuals") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#a02300") + 
  theme_bw()
```

```{r bivariate regression 6}
summary(bimod6)
```
**LogMEDINC09 vs. need** shows this variable to also be significant and also be associated with a large increase in need per unit increase in log adjusted income.


```{r Scatter Plot 7}
bimod7 <- lm(TOTAL_OFFICIAL_NEED ~ GrowingCity, data = cwns2012)

bimod7_resid <- augment(bimod7)

ggplot(bimod7_resid, aes(x = .fitted, y = .resid)) + 
  ggtitle("Growing City Regressed on Need") +
  xlab("Fitted") + ylab("Residuals") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#a02300") + 
  theme_bw()
```

```{r bivariate regression 7}
summary(bimod7)
```
**GrowingCity vs. need** shows that this variable is also significant and location in a growing city could be associated with an average increase of $12,760,382 in need.


```{r Scatter Plot 8}
bimod8 <- lm(TOTAL_OFFICIAL_NEED ~ lowincome, data = cwns2012)

bimod8_resid <- augment(bimod8)

ggplot(bimod8_resid, aes(x = .fitted, y = .resid)) + 
  ggtitle("Low Income City Regressed on Need") +
  xlab("Fitted") + ylab("Residuals") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#a02300") + 
  theme_bw()
```

```{r bivariate regression 8}
summary(bimod8)
```
**lowincome vs. need** shows that this variable is also significant and low-income cities are actually associated with an average $13,390,627 lower need than other cities.

<br>

## Multivariate Regression

Finally, we run a series of multivariate regressions to measure the degree to which the independent variables we hypothesized to be significant are linearly related to need.

### Model 1

For our first model, we begin with a selection of all our hypothesized significant variables that do not exhibit multi-collinearity according to our correlation tests:

* `PRES_RES_REC_TRMT` (cor with need = 0.53)
* `res_pop10_dens` (cor with need = 0.42)
* `CSS` (cor with need = 0.20)
* `LogPOP10` (cor with need = 0.18)
* `PCTWHITE10` (cor with need = -0.15)
* `LogMEDINC09` (cor with need = 0.05)
* `GrowingCity` (cor with need = .04)

```{r multivariate regresssion model 1}
#Interpreting regression results - key statistics:
#R-squared
  # Tells what % of the variability in the dependent variable is explained by the model
  # in other words - r-squared measures the strength of the relationship btwn the model
  # and dependent variable on a 0-100% scale
  # so, higher r-squared values represent smaller differences btwn the observed data
  # and the fitted values.
  # r-squared < 50% is common when studying human behavior
  # IMPORTANT NOTE: r-squared increases every time you add an independent variable to the model.
#Adjusted R-squared
  # Adjusts for the number of terms in the model!
  # Its value increases only when the new term improves the model fit more than expected by chance alone.
  # The adjusted R-squared value actually decreases when the term doesn’t improve the model fit enough.
  # Useful for comparing goodness-of-fit for regression models with differing numbers of independent variables.
#Multiple R-squared
#Significance codes
#F-statistic
  # a large f-stat means the model has a strong fit and we can reject the
  # null hypothesis that a null model (just the intercept) describes the data better.
  # If the p-value associated with the F-stat is ≥ 0.05 Then there is no relationship between ANY of the
  # independent variables and Y.
  # If the p-value associated with the F-statistic < 0.05 then AT LEAST 1 independent variable is related to Y.

mod1 <- lm (TOTAL_OFFICIAL_NEED ~ PRES_RES_REC_TRMT + res_pop10_dens + CSS + LogPOP10 + 
              PCTWHITE10 + LogMEDINC09 + GrowingCity, data = cwns2012)
summary(mod1)

```
**Interpreting the Results of Model 1**
The R-squared and adjusted R-squared tell us this first model describes ~37% of the variance in our data. There is room for improvement, but we are capturing some significant relationships. The p-value associated with the model's F-statistic is low, which tells us the model describes the data better than the mean. Every variable tested appears to be significant except for `PCTWHITE10`. Therefore, Model 1 could perform better, but seems like a promising start.

<br>

### Model 2

Next, we employ automated backwards selection on model 1 to see which, if any variables we can drop to improve the fit and efficiency of the model. We choose backwards selection, rather than forwards selection, because it allows us to use the entire variable list we developed previously as our starting point. This is preferable to forward selection, which would have required us to arbitrarily pick and then build off of a starting variable.

```{r mod 1 back step}
#AIC
  # Particularly helpful for backwards selection
  # it's a measure of the quality of a model and used to pick a model from many. 
  # AIC is all relative - just tells you what's the best one you have. 
  # the preferred model has the lowest AIC. And AIC increases with the number of explanatory variables.
mod2 <- step(mod1, direction = "backward")
```
The results of automated backwards selection tell us we can drop `PCTWHITE10` because the AIC is lower for the model when it is not included, showing that a model without `PCTWHITE10` has a better fit with the data. This gives us `mod2`.

```{r mod 2 anova}
anova(mod1, mod2)
```
Comparing `mod1` and `mod2` with an analysis of Variance Table gives a p-value much larger than the 0.05 threshold for statistically significant difference between the model's means. Therefore, while `mod2`'s AIC suggests it performs slightly better, running ANOVA suggests the models don't perform differently from eachother in a meaningful way.

```{r mod 2 summary}
summary(mod2)
```
Looking at `mod2`'s r-squared values, we see they are in fact the same as `mod1`. This means at the very least it is not worth keeping PCTWHITE10 in the model.

<br>  

### Model 3

What if we replace median income with our binary low income variable?

```{r mod 3}
mod3 <- lm (TOTAL_OFFICIAL_NEED ~ PRES_RES_REC_TRMT + res_pop10_dens + CSS + LogPOP10 + lowincome + GrowingCity, data = cwns2012)
summary(mod3)
```
<br>  

The r-squared got slightly worse. What does automated backward selection tell us?

```{r mod 3 back step}
#AIC
  # Particularly helpful for backwards selection
  # it's a measure of the quality of a model and used to pick a model from many. 
  # AIC is all relative - just tells you what's the best one you have. 
  # the preferred model has the lowest AIC. And AIC increases with the number of explanatory variables.
step(mod3, direction = "backward")
```
Backward selection tells us the model's fit is better with low income included than without. But, since `lowincome` and `LogMEDINC09` can't be in the same model and the r-squared was higher for the model with `LogMEDINC09` we choose to move forward with the original income variable rather than the low income dummy variable.

<br>  

### Model 4

What if we try interacting terms from model 2 instead?

```{r mod 4}
mod4 <- lm (TOTAL_OFFICIAL_NEED ~ PRES_RES_REC_TRMT + CSS + res_pop10_dens:CSS + LogPOP10 + LogMEDINC09 + GrowingCity,
            data = cwns2012)
summary(mod4)
```
Interacting `res_pop10_dens` with `css` improves the fit, but two variables lose their significance. What happens if we drop all non-significant terms? In this case, `LogPOP10` and `LogMEDINC09`.

<br>  

### Model 5

```{r mod5}
mod5 <- lm (TOTAL_OFFICIAL_NEED ~ PRES_RES_REC_TRMT + CSS + res_pop10_dens:CSS + GrowingCity,
            data = cwns2012)
summary(mod5)
```
Dropping these two variables only reduces the r-squared of `mod5` by 0.0002 and the adjusted r-squared by 0.0001. Also, the p-values associated with the f-statistic of the two models stay the same as well. Therefore, `mod5` is a leaner and essentially as mean model as `mod4` that performs just as well but doesn't carry the weight of insignificant variables.

<br>

### Model Selection

In order to select our final model, we create a table of each of the five models to compare their fitness (below). The table shows that models 4 and 5 are our best models. They have the highest r-squared and adjusted r-squared values, the lowest residual standard errors, and the largest F Statistics. We select model 5 as our final model because it achieves equal performance to model 4 with fewer variables and has the highest F Statistic of any of our models.

```{r stargazer, results='asis'}
stargazer(mod1, mod2, mod3, mod4, mod5, type="html", digits = 2, single.row = FALSE)
```


```{r multi-colinearity test mod5}
print('VIF')
vif(mod5) # variance inflation factors 
print('sqrt(VIF)')
sqrt(vif(mod5))
```
Finally, we check the VIF for Model 5 to ensure we have not selected a final model that has colinear independent variables. This test shows that the model's variables do not exhibit multi-colinearity because all of their VIF values are below 5 and their square root VIF values are below 2.




### Final Model: Model 5

After examining the relationship between total budgeted facility need and what feels like countless variables for this assignment, it seems surprising that just four variables describe variation in need better than any other combination we tested. However, when we think about which variables they are and the fact that the data is national, the results of our process make more sense.

The process in question, in which we went from a total of 48 potentially significant independent variables down to 7 to run multivariate regressions on, and eventually down to the 4 most significant, revealed that present residential population receiving treatment, residential population density, being a growing city, and presence of a combined sewer system are key drivers of wastewater facility budgetary need in the United States.

Independent Vars.  | Estimate    | Std. Error | t value | Pr(>|t|)   
------------------ | ----------- | ---------- | ------- | ---------------------
(Intercept)        | -1,985,000  | 2.225e+06  | -0.892  |  0.37238  
PRES_RES_REC_TRMT  | $558        | 11.1       | 50.177  | < 0.00000000000000002
CSS                | $25,060,000 | 4380000    | 5.722   | 0.0000000109
CSS:res_pop10_dens | 91,680      | 2566       | 35.729  | < 0.00000000000000002
GrowingCity        | $6,801,000  | 2564000    | 2.652   | 0.00801


Specifically, the coefficients of our final model (shown in the table above) predict that:

* **For every 1 unit increase in residential population receiving treatment, all else equal, we can expect a $565 increase in facility budgetary need.** While this value may seem relatively small, it grows quickly. Especially when considering facilities like Philadelphia's which serve an average of 760,534 people. If an additional 1,000 people move into that district, we predict that facility's need to increase by $565,000.

* Since "CSS" is a binary variable based on the presence or absence of a combined sewer system, and the interaction between CSS and residential population density is highly significant (due to its small p-value), **the effect of residential population density on budgeted facility need is only significant when that facility has a CSS.**

* Because CSS is a binary dummy variable, we interpret its standalone coefficient differently. It tells us that **the average increase in need for facilities with a CSS instead of MS4 is a shocking $23,550,000.**

* *It is also important to recognize that the effect of CSS on the model is shaped by its interaction with residential population density. In this model, when combined sewers are not present (CSS = 0) the slope of the regression line equals the coefficient for* `PRES_RES_REC_TRMT`.

* Finally, **the average increase in need for growing cities is also quite high at $6,801,000.**


**Overall Model**  
The r-squared value of this model is **0.392**, which means that the predictor variables explain about 39% of the variability in the response variable `TOTAL_OFFICIAL_NEED`.

```{r plot residuals mod 5, fig.width=9}
#fitted values are predicted values (in this case, need)

mod5_resid <- augment(mod5)

gg5resfull <- ggplot(mod5_resid, aes(x = .fitted, y = .resid)) + 
  ggtitle("Model 5 Residuals") +
  xlab("Fitted") + ylab("Residuals") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#a02300") + 
  geom_vline(aes(xintercept=mean(TOTAL_OFFICIAL_NEED)), color="#E1B93C") +
  geom_vline(aes(xintercept=mean(philly_facilities$TOTAL_OFFICIAL_NEED)), color="#a02300") +
  theme_bw()

gg5rescut <- ggplot(mod5_resid, aes(x = .fitted, y = .resid)) + 
  ggtitle("Model 5 Residuals (Cropped)") +
  xlab("Fitted") + ylab("Residuals") +
  geom_point(size=1, color="black", fill="#6496b4", shape=21, alpha=.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#a02300") + 
  geom_vline(aes(xintercept=mean(TOTAL_OFFICIAL_NEED)), color="#E1B93C") +
  geom_vline(aes(xintercept=mean(philly_facilities$TOTAL_OFFICIAL_NEED)), color="#a02300") +
  xlim(0, 200000000) +
  theme_bw()

grid.arrange(gg5resfull, gg5rescut, ncol = 2)

```

Plotting the residuals against the predicted or "fitted" values of our final model reveals a clustering around lower values, or heteroscedasticity. Plotting the residuals of an ideal model would show homoscedasticity - a random yet equal distribution around the regression line. The heteroscedasticity in our model means it predicts better (is more accurate) at low values of need than at high ones.

The above plots show mean facility need in the United States with a vertical yellow line and mean facility need for Philadelphia with a red line. The plot on the left includes the full range of data and shows that unfortunately the model does not predict very accurately when need is in the range of Philadelphia's. However, the zoomed in plot on the right shows that the residuals are much more symmetric around the regression line for values closer to mean U.S. facility need. This suggests that our model is useful for estimating need in cities with average need.

<br>

>In summary, the results of this model are of significance to cities that have large numbers of present residences receiving treatment, combined sewers, higher than average population density, and are growing. Philly fits all of these descriptors. The city's population density and residences receiving treatment are projected to increase, it has a CSS, and the city appears to still be growing. This makes clear that Philly's need for water infrastructure investment, while currently quite high, will only continue to increase in the future. Therefore, investment in this infrastructure is an absolute MUST!







